<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2018-09-07 
 | Rendered using Apache Maven Fluido Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20180907" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Applications - Query table - EventFlow Fragment &#x2013; Query table fragment</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.5.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.5.min.js"></script>

                      </head>
        <body class="topBarDisabled">
          
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>Applications - Query table - EventFlow Fragment</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
              
                  <li id="publishDate">Last Published: 2018-09-07
                      <span class="divider">|</span>
                   </li>
                  <li id="projectVersion">Version: 1.0.0
                      </li>
                      
              
      
                            </ul>
      </div>

                  
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
              
                <ul class="nav nav-list">
                    <li class="nav-header">Overview</li>
                              
      <li class="active">
  
            <a href="#"><span class="none"></span>Introduction</a>
          </li>
                
      <li>
  
                          <a href="using.html" title="Using">
          <span class="none"></span>
        Using</a>
            </li>
                              <li class="nav-header">Project Documentation</li>
                                                                                                                                                        
      <li>
  
                          <a href="project-info.html" title="Project Information">
          <span class="icon-chevron-right"></span>
        Project Information</a>
                  </li>
                                                                  
      <li>
  
                          <a href="project-reports.html" title="Project Reports">
          <span class="icon-chevron-right"></span>
        Project Reports</a>
                  </li>
            </ul>
              
                
          <hr />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                        
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>Query table fragment</h1>
<p>This fragment is part of the query table sample and shows how to use a query table backed by transactional memory.</p>
<ul>

<li>EventFlow that stores and queries bids and asks in a query table</li>
</ul>
<p><img src="../resources/images/Querytable.png" alt="Application" /></p>
<ul>

<li>Query table is backed by transactional memory</li>
</ul>
<p><img src="../resources/images/Tablesettings.png" alt="Table settings" /></p>
<ul>

<li>Data distribution policy <b>dynamic</b> is selected</li>
</ul>
<p><img src="../resources/images/Policy.png" alt="Policy" /></p>
<ul>

<li>Data is partitioned by the <b>key field symbol</b></li>
</ul>
<p><img src="../resources/images/Schema.png" alt="Schema" /></p>
<ul>

<li><a href="../../test/java/com/tibco/ep/samples/querytable/TestCase.java">Junit test case</a></li>
</ul>
<p>Test application definition HOCON file :</p>

<div>
<div>
<pre class="source">name = &quot;MyApplication&quot;
version = &quot;1.0&quot;
type = &quot;com.tibco.ep.dtm.configuration.application&quot;
 
configuration = {
    ApplicationDefinition = {
 
        dataDistributionPolicies = {
            dynamic = {
                type = DYNAMIC
                dynamicDataDistributionPolicy = {
                    numberOfPartitions = 3
                    primaryDataRedundancy = {
                        numberOfReplicas = 6
                        replicationType = SYNCHRONOUS
                    }
                    backupDataRedundancy = {
                        numberOfReplicas = 4
                        replicationType = ASYNCHRONOUS
                    }
                }
            }
        }
 
    }
}

</pre></div></div>

<p>Test node deployment HOCON file :</p>

<div>
<div>
<pre class="source">name = &quot;MyApplication&quot;
version = &quot;1.0&quot;
type = &quot;com.tibco.ep.dtm.configuration.node&quot;
 
configuration = {
    NodeDeploy = {
        nodes = {
            &quot;${EP_NODE_NAME}&quot; = {
            }
        }
 
        availabilityZones = {
            DC1 = {
                dataDistributionPolicy = &quot;dynamic&quot;
             }
        }
 
    }
}
</pre></div></div>

<p>Test case :</p>

<div>
<div>
<pre class="source">    /**
     * test case
     * 
     * @throws StreamBaseException on error
     */
    @Test
    public void test1() throws StreamBaseException {
        LOGGER.info(&quot;Test Case 1&quot;);

        Administration admin = new Administration();
        
        // should insert one row
        //
        server.getEnqueuer(&quot;WriteInput&quot;).enqueue(JSONSingleQuotesTupleMaker.MAKER, &quot;{'time_int':1,'symbol':'AAA','bid_price':100, 'bid_size':1, 'ask_price':1.1, 'ask_size':1, 'sequence':1 }&quot;);

        // check dequeue
        //
        server.getEnqueuer(&quot;ReadInput&quot;).enqueue(JSONSingleQuotesTupleMaker.MAKER, &quot;{'symbol':'AAA'}&quot;);

        // check transactional memory
        //
        for (int i=0; i&lt;10; i++) {
            if (admin.execute(&quot;read&quot;, &quot;querytable&quot;).toDtmResults().get().getResultSet().getRows().size() &gt; 0) {
                break;
            }
            try {
                Thread.sleep(200);
            } catch (InterruptedException e) {
            }
        }
        assertEquals(&quot;AAA,100.0,1.0&quot;, admin.execute(&quot;read&quot;, &quot;querytable&quot;).toDtmResults().get().getResultSet().getRow(0).getColumn(1));

        // update one row
        //
        server.getEnqueuer(&quot;WriteInput&quot;).enqueue(JSONSingleQuotesTupleMaker.MAKER,&quot;{'time_int':1,'symbol':'AAA','bid_price':200, 'bid_size':2, 'ask_price':2.2, 'ask_size':2, 'sequence':2 }&quot;);

        // check dequeue
        //
        server.getEnqueuer(&quot;ReadInput&quot;).enqueue(JSONSingleQuotesTupleMaker.MAKER, &quot;{'symbol':'AAA'}&quot;);

        // check transactional memory
        //
        assertEquals(&quot;AAA,200.0,2.0&quot;, admin.execute(&quot;read&quot;, &quot;querytable&quot;).toDtmResults().get().getResultSet().getRow(0).getColumn(1));

        // non-existing
        //
        server.getEnqueuer(&quot;ReadInput&quot;).enqueue(JSONSingleQuotesTupleMaker.MAKER, &quot;{'symbol':'BBB'}&quot;);
    }
</pre></div></div>

<p>Expected results :</p>

<div>
<div>
<pre class="source">[INFO] --- ep-maven-plugin:1.4.0-SNAPSHOT:test-eventflow-fragment (default-test-eventflow-fragment) @ querytable_eventflowfragment ---
[INFO] [dtm] INFO: Deploy tool version: [TIBCO Distributed Transactional Memory Platform 10.4.0-SNAPSHOT (build 1808220850)] starting at [Wed Aug 22 11:50:26 BST 2018]
[INFO] [dtm] INFO: Node version: [TIBCO StreamBase Runtime 10.4.0-SNAPSHOT (build 1808220859)]
[INFO] [dtm] INFO: Starting com.tibco.ep.buildmavenplugin.surefire.Runner on node A.querytable_eventflowfragment ...
[INFO] [dtm] INFO: com.tibco.ep.buildmavenplugin.surefire.Runner started on JVM com_tibco_ep_buildmavenplugin_surefire_Runner0 on node A.querytable_eventflowfragment.
[INFO] [A.querytable_eventflowfragment] No user-defined Logback configuration, using product default configuration
[INFO] [A.querytable_eventflowfragment] 2018-08-22 11:50:30.572000+0100 [81977:main] INFO  com.tibco.ep.dtm.stdout:
[INFO] [A.querytable_eventflowfragment] -------------------------------------------------------
[INFO] [A.querytable_eventflowfragment]  T E S T S
[INFO] [A.querytable_eventflowfragment] -------------------------------------------------------
[INFO] [A.querytable_eventflowfragment] Running com.tibco.ep.samples.querytable.TestCase
[INFO] [A.querytable_eventflowfragment] Test Case 1
[INFO] [A.querytable_eventflowfragment] WriteLog(tupleid=0,symbol=&quot;AAA&quot;,bid_price=100.0,bid_size=1.0)
[INFO] [A.querytable_eventflowfragment] ReadLog(tupleid=0,symbol=&quot;AAA&quot;,bid_price=100.0,bid_size=1.0)
[INFO] [A.querytable_eventflowfragment] WriteLog(tupleid=0,symbol=&quot;AAA&quot;,bid_price=200.0,bid_size=2.0)
[INFO] [A.querytable_eventflowfragment] ReadLog(tupleid=0,symbol=&quot;AAA&quot;,bid_price=200.0,bid_size=2.0)
[INFO] [A.querytable_eventflowfragment] ReadLog(tupleid=0,symbol=&quot;null&quot;,bid_price=null,bid_size=null)
[INFO] [A.querytable_eventflowfragment] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 4.549 sec
[INFO] [A.querytable_eventflowfragment] 2018-08-22 11:50:35.127000+0100 [81977:main] INFO  com.tibco.ep.dtm.stdout:
[INFO] [A.querytable_eventflowfragment] Results :
[INFO] [A.querytable_eventflowfragment] 2018-08-22 11:50:35.127000+0100 [81977:main] INFO  com.tibco.ep.dtm.stdout:
[INFO] [A.querytable_eventflowfragment] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0
[INFO] [A.querytable_eventflowfragment] 2018-08-22 11:50:35.127000+0100 [81977:main] INFO  com.tibco.ep.dtm.stdout:
[INFO] [dtm] INFO: Engine com_tibco_ep_buildmavenplugin_surefire_Runner0 on node [A.querytable_eventflowfragment] exited with status [0]
[INFO] [querytable_eventflowfragment] Finished &quot;junit&quot;
</pre></div></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
                      <div class="row-fluid">
                                      <p >Copyright &copy;                    2015&#x2013;2018
                        <a href="http://www.tibco.com">TIBCO Software Inc.</a>.
            All rights reserved.    
      </p>
                </div>

        
                </div>
    </footer>
        </body>
</html>
